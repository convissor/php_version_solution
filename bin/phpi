#! /bin/bash

# See the "USER CONFIGURATION" section in the middle of the file.

usage="
Usage:  phpi <branch>
  @param string <branch>  the major version to install (52, 53, 54, tr)

Installs the PHP binary compiled in your regular user account via 'phpcm'.

See Also:  peart, phpcm, phprm, phpt, phput, phpvs

This is part of the PHP Version Solution:
https://github.com/convissor/php_version_solution
"

if [[ $1 == "-h" || $1 == "--help" || $1 == "help" ]] ; then
	echo "$usage"
	exit 1
fi

if [ -z $1 ] ; then
	echo "ERROR: pass in the PHP branch to install"
	echo "$usage"
	exit 1
fi

major=${1:0:2}
major=${major^^*}
src_var=PHPVS_SRC_$major

if [ -z "${!src_var}" ] ; then
	echo "ERROR: the environment variable $src_var does not exist."
	echo "Two options: 1) Use a supported version, or 2) add it to"
	echo "$PHPVS_LIB_PATH/phpvs, run 'source ~/.bashrc',"
	echo "and try again."
	echo "$usage"
	exit 1
fi
if [ ! -d ${!src_var} ] ; then
	echo "ERROR: the following source directory does not exist:"
	echo ${!src_var}
	echo "Edit $src_var in $PHPVS_LIB_PATH/phpvs,"
	echo "run 'source ~/.bashrc', and try again."
	exit 1
fi


cd ${!src_var}

if [[ ! -f ext/date/php_date.lo || ! -f phpvs-prefix.txt ]] ; then
	echo "ERROR: your regular user hasn't run 'phpcm' yet."
	exit 1
fi

prefix=`cat phpvs-prefix.txt`
version=${prefix##*/}

make install
if [ $? -ne 0 ] ; then
	echo "ERROR: PHP 'make install' choked."
	exit 1
fi

phpvs $version
if [ $? -ne 0 ] ; then
	exit 1
fi


# vvvvvvvvvvvvvvvvvvvvvvvvv
# USER CONFIGURATION (UC)

# UC:  First, specify which PECL packages to install for all versions.
# Format: [package_name]=extension_type
declare -A pecl_packages=(
	[memcache]=extension
	[mongo]=extension
)

# UC:  Then specify additional PECL packages for particular versions.
case $major in
	52)
		ext_dir=$prefix/lib/php/20060613
		pecl_packages[xdebug]=zend_extension
		;;
	53)
		ext_dir=$prefix/lib/php/20090626
		pecl_packages[xdebug]=zend_extension
		;;
	54|TR)
		ext_dir=$prefix/lib/php/20100525
		# Xdebug isn't ready for these branches yet.
		;;
	*)
		echo "ERROR: add $major to case statement in phpi and try again."
		exit 1
		;;
esac

# ^^^^^^^^^^^^^^^^^^^^^^^^^


ini_dest="$prefix/lib"
ext_ini=$ini_dest/extensions.php.ini

if [ ! -e "$ini_dest/main.php.ini" ] ; then
	ln -s $PHPVS_LIB_PATH/main.php.ini $ini_dest/main.php.ini
fi

if [[ "${!pecl_packages[@]}" == *xdebug* ]] ; then
	if [ ! -e $ini_dest/xdebug.php.ini ] ; then
		ln -s $PHPVS_LIB_PATH/xdebug.php.ini $ini_dest/xdebug.php.ini
	fi
else
	rm -f $ini_dest/xdebug.php.ini
fi

echo "; Generated by /usr/local/bin/phpi" > $ext_ini
for package in ${!pecl_packages[@]} ; do
	pecl install $package
	if [ $? -ne 0 ] ; then
		echo ""
		echo "WARNING: phpi could not install $package.  See message, above."
		echo "If it is a real problem, delete $package from $ext_ini."
		echo ""
	fi

	# Do this because 5.2 doesn't like full path on regular extensions.
	if [ ${pecl_packages[$package]} == extension ] ; then
		echo "${pecl_packages[$package]} = $package.so" >> $ext_ini
	else
		echo "${pecl_packages[$package]} = $ext_dir/$package.so" >> $ext_ini
	fi
done


# Disable this PEAR to avoid conflicts with the main PEAR install.
chmod 644 $prefix/bin/pear


if [[ -f /usr/bin/php && ! -h /usr/bin/php ]] ; then
	echo "NOTICE: /usr/bin/php exists.  Symlink from it will not be created."
else
	ln -fs $prefix/bin/php /usr/bin/php
	ln -fs $prefix/bin/php-cgi /usr/bin/php-cgi
fi

if [[ -f /usr/local/bin/php && ! -h /usr/local/bin/php ]] ; then
	echo "NOTICE: /usr/local/bin/php exists.  Symlink from it will not be created."
else
	ln -fs $prefix/bin/php /usr/local/bin/php
	ln -fs $prefix/bin/php-cgi /usr/local/bin/php-cgi
fi


if [ -x /etc/init.d/apache2 ] ; then
	if [[ "$major" > "53" || $version == *.ap* ]] ; then
		/etc/init.d/apache2 restart
	fi
fi

if [ -x /etc/init.d/lighttpd ] ; then
	if [[ "$major" < "53" ]] ; then
		echo "WARNING: lighttpd is not compatible with PHP 5.2"
		/etc/init.d/lighttpd stop
	elif [[ "$major" > "53" || $version != *.ap* ]] ; then
		/etc/init.d/lighttpd restart
	fi
fi
